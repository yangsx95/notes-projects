<html>
  <head>
    <meta charset="UTF-8">
    <title>5. Day05 - Gaiden</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css\bootstrap.min.css">
    <link rel="stylesheet" href="css\font-awesome.min.css">
    <link rel="stylesheet" href="css\highlight.css">
    <link rel="stylesheet" href="css\style.css">
    <link rel="stylesheet" href="css\my.css">
  </head>
  <body>
    <div class="wrapper">
      <div class="header">
        <i class="fa fa-bars sidebar-toggle"></i>
        <span class="title"><a href="Day01.html">Gaiden</a></span>
      </div>
      <div class="sidebar">
        <ul>
          <li class="numbered visible">
            <a href="Day01.html" data-alt-hash="day01"><span class="number">1.</span>Day01</a>
            <ul>
              <li class="numbered visible">
                <a href="Day01.html#id-7162f5a11c8e3a956d9aa4ee917bff96000fbc98"><span class="number">1.1.</span>任务详细说明</a>
                <ul>
                  <li class="numbered visible"><a href="Day01.html#mvc"><span class="number">1.1.1.</span>创建项目按照MVC的架构模式创建相应的包结构如下图：</a></li>
                  <li class="numbered visible"><a href="Day01.html#pomxml"><span class="number">1.1.2.</span>pom.xml的依赖配置：</a></li>
                  <li class="numbered visible"><a href="Day01.html#hibernatehibernatecfgxml"><span class="number">1.1.3.</span>配置hibernate的主配置文件:hibernate.cfg.xml</a></li>
                  <li class="numbered visible"><a href="Day01.html#hibernate"><span class="number">1.1.4.</span>根据分析创建实体，并做hibernate的映射，根据需求文档的物理设计</a></li>
                  <li class="numbered visible"><a href="Day01.html#hibernatesession"><span class="number">1.1.5.</span>hibernate的session工具类</a></li>
                  <li class="numbered visible"><a href="Day01.html#id-95d0a5f0a237ffc3bd210b185d1403a7d5bd0b0b"><span class="number">1.1.6.</span>通过过滤器设置请求和回应编码以及权限控制</a></li>
                  <li class="numbered visible"><a href="Day01.html#bean"><span class="number">1.1.7.</span>为了解除各层之间的耦合性，提供一个bean工厂，来实现解耦合，</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="numbered visible">
            <a href="Day02.html" data-alt-hash="day02"><span class="number">2.</span>Day02</a>
            <ul>
              <li class="numbered visible">
                <a href="Day02.html#id-af156bad56b1c2a8dd04f104684a49eb3d4746d7"><span class="number">2.1.</span>任务详情说明</a>
                <ul>
                  <li class="numbered visible"><a href="Day02.html#id-d4579bbd2acc523dc6247c6313a2eb938ed40b41"><span class="number">2.1.1.</span>视图层:</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-16a5af49bb761ed22ec9795aa5db3ab2509b2fb5"><span class="number">2.1.2.</span>控制层：</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-bd5a39d61fc4d09c931d2b4d375ed25242ae7146"><span class="number">2.1.3.</span>业务层：</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-63f45e92b7c574a974500c309a10d022ad4c2dfc"><span class="number">2.1.4.</span>数据访问层</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-9847283c8e82f7ef2487ee4d3f3e94020aa37b1f"><span class="number">2.1.5.</span>商品首页的显示</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-07cce4c07eab88c6b2d963af79a17ab00acd87cb"><span class="number">2.1.6.</span>图书的分类查询：</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-1e90f40b7b77f956fa693e906060db7af1e670c8"><span class="number">2.1.7.</span>商品详情页：</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="numbered visible">
            <a href="Day03.html" data-alt-hash="day03"><span class="number">3.</span>Day03</a>
            <ul>
              <li class="numbered visible">
                <a href="Day03.html#id-914140ee94022822a51225fd8f39e9a54d6f79e5"><span class="number">3.1.</span>任务详情说明</a>
                <ul>
                  <li class="numbered visible"><a href="Day03.html#id-2a7ae62eb10734335d176e0235a52d41b1fab0fc"><span class="number">3.1.1.</span>功能设计</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="numbered visible">
            <a href="Day04.html" data-alt-hash="day04"><span class="number">4.</span>Day04</a>
            <ul>
              <li class="numbered visible">
                <a href="Day04.html#id-a1f28bf4e37b3b38d040c0438a82b4adb42e90a9"><span class="number">4.1.</span>任务详情说明</a>
                <ul>
                  <li class="numbered visible">
                    <a href="Day04.html#id-eebd10b9ea0ed96f1e7f9d66f2d9ddaefcabea4e"><span class="number">4.1.1.</span>功能设计</a>
                    <ul>
                      <li class="numbered invisible">
                        <a href="Day04.html#id-e1703107bce8a40037a8f02bf904265ad6136b82"><span class="number">4.1.1.1.</span>后台服务程序处理：</a>
                        <ul>
                          <li class="unnumbered invisible"><a href="Day04.html#id-db1624598f0a892a82cf7a24b3c9dd669a25f64c">购物车页面如下：</a></li>
                          <li class="unnumbered invisible"><a href="Day04.html#id-ce7b674841625c853dd4a98d8722a6d85252eaa0">购物车业务层接口定义：</a></li>
                          <li class="unnumbered invisible"><a href="Day04.html#id-3c7430c3a8cbc9fa43438c6534596d71a20c6c32">参考实现：</a></li>
                          <li class="unnumbered invisible"><a href="Day04.html#id-641946fb95fb38bf7525d2d10ec27e3ee682dddf">控制层：</a></li>
                          <li class="unnumbered invisible"><a href="Day04.html#jsp">JSP页面</a></li>
                          <li class="unnumbered invisible"><a href="Day04.html#id-ed6c5112aa07b28edbeee6bdd8d145ec6455b893">页面视图展示：</a></li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="numbered visible">
            <a href="Day05.html" data-alt-hash="day05"><span class="number">5.</span>Day05</a>
            <ul>
              <li class="numbered visible">
                <a href="Day05.html#id-5053eee6be99caad723b2f22524c1e2addfee6e9"><span class="number">5.1.</span>任务详细说明：</a>
                <ul>
                  <li class="numbered visible"><a href="Day05.html#id-2a4b9f847b652c5d8aed18c9d80398b917dab9c7"><span class="number">5.1.1.</span>功能设计</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="numbered visible">
            <a href="Day06.html" data-alt-hash="day06"><span class="number">6.</span>Day06</a>
            <ul>
              <li class="numbered visible">
                <a href="Day06.html#id-8de5978d4021ae9620176dbd1451f544ff8f798e"><span class="number">6.1.</span>任务单详细说明：</a>
                <ul>
                  <li class="numbered visible"><a href="Day06.html#id-4c4580cc53ffa82ec1a481ce14f72537efb100ee"><span class="number">6.1.1.</span>功能设计</a></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </div>
      <div class="content">
        <div class="content-handle"></div>
        <div class="content-container">
          <div class="content-nav content-nav-top">
            <a class="prev-page" href="Day04.html">
            <i class="fa fa-angle-left"></i>
            <span class="number">4.</span>
            Day04
            </a>
            <a class="next-page" href="Day06.html">
            <span class="number">6.</span>
            Day06
            <i class="fa fa-angle-right"></i>
            </a>
          </div>
          <div class="page-toc">
            <ul>
              <li class="numbered visible">
                <a href="#day05"><span class="number">5.</span>Day05</a>
                <ul>
                  <li class="numbered visible">
                    <a href="#id-5053eee6be99caad723b2f22524c1e2addfee6e9"><span class="number">5.1.</span>任务详细说明：</a>
                    <ul>
                      <li class="numbered visible"><a href="#id-2a4b9f847b652c5d8aed18c9d80398b917dab9c7"><span class="number">5.1.1.</span>功能设计</a></li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
          <div class="main-content">
            <h1 id="day05"><span class="number">5.</span>Day05</h1>
            <h2 id="id-5053eee6be99caad723b2f22524c1e2addfee6e9"><span class="number">5.1.</span>任务详细说明：</h2>
            <h3 id="id-2a4b9f847b652c5d8aed18c9d80398b917dab9c7"><span class="number">5.1.1.</span>功能设计</h3>
            <p>此功能是在添加购物车功能的基础上，进行对购物车中商品数量进行修改、删除和清空购物车功能</br></p>
            <p>控制器功能： <img src="../img/213.png" alt="购物车控制"/></br> CartAction.java 购物车功能控制器</br></p>
            <p><span style="color:red">在此强调，以上的图示只是一个参考，你完全可以自行定义任意的Action</span></br></p>
            <p>购物车页面： <img src="../img/214.png" alt="购物车"/></br> 此页面的详细介绍：</br> 1、继续买，表示回到图书选购页面。</br> 2、删除功能，可以删除选中的一或多个购物条目。</br> 3、数量修改功能，数据可以添加或减少，但不能为负数。</br> 4、结算功能，进入到结束页面，并把购物车中的数据传递到下一个页面。</br></p>
            <p>1.继续买：</br> 此操作的请求传到控制器，由控制器响应一个图书页面给客户短，比较容易实现</br></p>
            <p>2.删除购物车：</br> 在做删除功能时，要选择中要删除的商品</br> 前台ajax处理代码【<span style="color:red">只是参考</span>】</br>：</p>
            <pre><code class="java">    	function removeCart(){
			var ids = &quot;&quot;;
			var count = 0;
			var checks = document.getElementsByName(&quot;itemCheck&quot;);
			for(var i=0;i&lt;checks.length;i++){
				if(checks[i].checked){
					count++;
					ids += checks[i].value+&quot;:&quot;;
				}
			}
			
			if(count &lt; 1){
				alert(&quot;至少选中一个商品!!!&quot;)
				return ;
			}else {
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function(){
					if(xmlHttp.status == 200){
						if(xmlHttp.readyState == 4){
							var str = xmlHttp.responseText;
							
							if(str == &#39;1&#39;){
								alert(&quot;成功删除!!!&quot;);
								location = &quot;${path }/cart/showcart&quot;;
							}
						}
					}
				}
				var url = &quot;${path }/cart/removeCartAjax?ids=&quot;+ids;
				xmlHttp.open(&quot;get&quot;,url,true);
				xmlHttp.send();
				
			}
		}
</code></pre>
            <p>请求发送到后台，后台控制器操作的代码片段：【<span style="color:red">只是参考</span>】</br></p>
            <pre><code class="java">case _REMOVE_CART:
    			try {
					/**接受发送来要删除的id字符串*/
					String ids = request.getParameter(&quot;ids&quot;);
					/**将id字符串分割成单个id数组，并且遍历这个数组，根据id来逐个删除商品信息,成功则返回&#39;1&#39;*/
					String[] arr = ids.substring(0, ids.length() - 1).split(&quot;:&quot;);// 把接收到的ID分开成数组
					for (String id : arr) {
						shoppingCart.delete(Long.valueOf(id));
					}
					out.print(&quot;1&quot;);
				} catch (Exception e) {
					// TODO: handle exception
					/**有异常返回&#39;0&#39;*/
					out.print(&quot;0&quot;);
					e.printStackTrace();
				}
				break;
</code></pre>
            <p>购物车中的处理逻辑代码片段:【<span style="color:red">只是参考</span>】</br></p>
            <pre><code class="java">@Override
    public void delete(Long bookId) {
		//
		OrderItem oi = find(bookId);
		//
		if(oi != null) {
			items.remove(bookId);
			//更新
			update();
		}
		
	}
</code></pre>
            <p>3.修改购物车 此修改是在购物车中商品列的输入框中修改数量，然后利用失去焦点事件，利用ajax发送请求到后台 服务进行修改购物车中商品数量：</br></p>
            <p>前台ajax的核心代码：【<span style="color:red">只是参考</span>】</br></p>
            <pre><code class="java">function modifyItem(id,obj){
    		var count = obj.value;
			if(/^[1-9]\d*$/.test(count)){
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function(){
					if(xmlHttp.status == 200){
						if(xmlHttp.readyState == 4){
							var str = xmlHttp.responseText;
							
							if(str == &#39;1&#39;){
								alert(&quot;成功修改!!!&quot;);
								location.reload();
							}
						}
					}
				}
				var url = &quot;${path }/cart/modifyCartAjax?bookId=&quot;+id+&quot;&amp;count=&quot;+count;
				xmlHttp.open(&quot;get&quot;,url,true);
				xmlHttp.send();
				
			}else {
				alert(&quot;数字格式不对!!!&quot;);
			}
		}
</code></pre>
            <p>后台控制器处理：【<span style="color:red">只是参考</span>】</br></p>
            <pre><code class="java">case _MODIFYCART:
    			/* PrintWriter out = response.getWriter(); */
				try {
					/**接收页面发来的修改参数*/
					String bookId = request.getParameter(&quot;bookId&quot;);
					String count = request.getParameter(&quot;count&quot;);
					/**根据参数修改购物车的数据，成功没有异常就返回‘1’*/
					shoppingCart.modifyCount(Long.valueOf(bookId), Integer.parseInt(count));
					out.write(&quot;1&quot;);
				} catch (Exception e) {
					// TODO: handle exception
					/**有异常则返回&#39;0&#39;*/
					out.print(&quot;0&quot;);
					e.printStackTrace();
				}
				break;
</code></pre>
            <p>购物车中逻辑处理：【<span style="color:red">只是参考</span>】</br></p>
            <pre><code class="java">@Override
    public void modifyCount(Long bookId, int count) {
		//
		OrderItem oi = find(bookId);
		//修改数量
		if(oi != null) {
			//进一步验证参数的有效性
			if(count &gt; 0) {
				oi.setCount(count);
				//更新属性
				update();
			} else {
				throw new RuntimeException(&quot;修改的数量不合法&quot;);
			}
		}
	}
    
    /****
     * 此方法的目的就是更新total属性和count属性值
	 */
	private void update() {
		//先清0
		this.total = 0;
		this.count = 0;
		//迭代
		Set&lt;Long&gt; keys = items.keySet();
		//
		for(Long bookId : keys) {
			OrderItem value = items.get(bookId);
			//把费用添加起来
			this.total += (value.getPrice()*value.getCount());
			//把商品总数加起来
			this.count += value.getCount();
		}
	}

</code></pre>
            <p>4.结算功能【<span style="color:red">进入到第6个任务单</span>】</p>
          </div>
          <div class="content-nav content-nav-bottom">
            <a class="prev-page" href="Day04.html">
            <i class="fa fa-angle-left"></i>
            <span class="number">4.</span>
            Day04
            </a>
            <a class="next-page" href="Day06.html">
            <span class="number">6.</span>
            Day06
            <i class="fa fa-angle-right"></i>
            </a>
          </div>
          <div class="footer">
            <p class="credit text-muted">Powered by <a href="https://github.com/kobo/gaiden">Gaiden</a></p>
          </div>
        </div>
      </div>
    </div>
    <script src="js\jquery-2.1.1.min.js"></script>
    <script src="js\highlight.js"></script>
    <script src="js\application.js"></script>
    <script src="js\my.js"></script>
  </body>
</html>
