<html>
  <head>
    <meta charset="UTF-8">
    <title>6. Day06 - Gaiden</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css\bootstrap.min.css">
    <link rel="stylesheet" href="css\font-awesome.min.css">
    <link rel="stylesheet" href="css\highlight.css">
    <link rel="stylesheet" href="css\style.css">
    <link rel="stylesheet" href="css\my.css">
  </head>
  <body>
    <div class="wrapper">
      <div class="header">
        <i class="fa fa-bars sidebar-toggle"></i>
        <span class="title"><a href="Day01.html">Gaiden</a></span>
      </div>
      <div class="sidebar">
        <ul>
          <li class="numbered visible">
            <a href="Day01.html" data-alt-hash="day01"><span class="number">1.</span>Day01</a>
            <ul>
              <li class="numbered visible">
                <a href="Day01.html#id-7162f5a11c8e3a956d9aa4ee917bff96000fbc98"><span class="number">1.1.</span>任务详细说明</a>
                <ul>
                  <li class="numbered visible"><a href="Day01.html#mvc"><span class="number">1.1.1.</span>创建项目按照MVC的架构模式创建相应的包结构如下图：</a></li>
                  <li class="numbered visible"><a href="Day01.html#pomxml"><span class="number">1.1.2.</span>pom.xml的依赖配置：</a></li>
                  <li class="numbered visible"><a href="Day01.html#hibernatehibernatecfgxml"><span class="number">1.1.3.</span>配置hibernate的主配置文件:hibernate.cfg.xml</a></li>
                  <li class="numbered visible"><a href="Day01.html#hibernate"><span class="number">1.1.4.</span>根据分析创建实体，并做hibernate的映射，根据需求文档的物理设计</a></li>
                  <li class="numbered visible"><a href="Day01.html#hibernatesession"><span class="number">1.1.5.</span>hibernate的session工具类</a></li>
                  <li class="numbered visible"><a href="Day01.html#id-95d0a5f0a237ffc3bd210b185d1403a7d5bd0b0b"><span class="number">1.1.6.</span>通过过滤器设置请求和回应编码以及权限控制</a></li>
                  <li class="numbered visible"><a href="Day01.html#bean"><span class="number">1.1.7.</span>为了解除各层之间的耦合性，提供一个bean工厂，来实现解耦合，</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="numbered visible">
            <a href="Day02.html" data-alt-hash="day02"><span class="number">2.</span>Day02</a>
            <ul>
              <li class="numbered visible">
                <a href="Day02.html#id-af156bad56b1c2a8dd04f104684a49eb3d4746d7"><span class="number">2.1.</span>任务详情说明</a>
                <ul>
                  <li class="numbered visible"><a href="Day02.html#id-d4579bbd2acc523dc6247c6313a2eb938ed40b41"><span class="number">2.1.1.</span>视图层:</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-16a5af49bb761ed22ec9795aa5db3ab2509b2fb5"><span class="number">2.1.2.</span>控制层：</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-bd5a39d61fc4d09c931d2b4d375ed25242ae7146"><span class="number">2.1.3.</span>业务层：</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-63f45e92b7c574a974500c309a10d022ad4c2dfc"><span class="number">2.1.4.</span>数据访问层</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-9847283c8e82f7ef2487ee4d3f3e94020aa37b1f"><span class="number">2.1.5.</span>商品首页的显示</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-07cce4c07eab88c6b2d963af79a17ab00acd87cb"><span class="number">2.1.6.</span>图书的分类查询：</a></li>
                  <li class="numbered visible"><a href="Day02.html#id-1e90f40b7b77f956fa693e906060db7af1e670c8"><span class="number">2.1.7.</span>商品详情页：</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="numbered visible">
            <a href="Day03.html" data-alt-hash="day03"><span class="number">3.</span>Day03</a>
            <ul>
              <li class="numbered visible">
                <a href="Day03.html#id-914140ee94022822a51225fd8f39e9a54d6f79e5"><span class="number">3.1.</span>任务详情说明</a>
                <ul>
                  <li class="numbered visible"><a href="Day03.html#id-2a7ae62eb10734335d176e0235a52d41b1fab0fc"><span class="number">3.1.1.</span>功能设计</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="numbered visible">
            <a href="Day04.html" data-alt-hash="day04"><span class="number">4.</span>Day04</a>
            <ul>
              <li class="numbered visible">
                <a href="Day04.html#id-a1f28bf4e37b3b38d040c0438a82b4adb42e90a9"><span class="number">4.1.</span>任务详情说明</a>
                <ul>
                  <li class="numbered visible">
                    <a href="Day04.html#id-eebd10b9ea0ed96f1e7f9d66f2d9ddaefcabea4e"><span class="number">4.1.1.</span>功能设计</a>
                    <ul>
                      <li class="numbered invisible">
                        <a href="Day04.html#id-e1703107bce8a40037a8f02bf904265ad6136b82"><span class="number">4.1.1.1.</span>后台服务程序处理：</a>
                        <ul>
                          <li class="unnumbered invisible"><a href="Day04.html#id-db1624598f0a892a82cf7a24b3c9dd669a25f64c">购物车页面如下：</a></li>
                          <li class="unnumbered invisible"><a href="Day04.html#id-ce7b674841625c853dd4a98d8722a6d85252eaa0">购物车业务层接口定义：</a></li>
                          <li class="unnumbered invisible"><a href="Day04.html#id-3c7430c3a8cbc9fa43438c6534596d71a20c6c32">参考实现：</a></li>
                          <li class="unnumbered invisible"><a href="Day04.html#id-641946fb95fb38bf7525d2d10ec27e3ee682dddf">控制层：</a></li>
                          <li class="unnumbered invisible"><a href="Day04.html#jsp">JSP页面</a></li>
                          <li class="unnumbered invisible"><a href="Day04.html#id-ed6c5112aa07b28edbeee6bdd8d145ec6455b893">页面视图展示：</a></li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="numbered visible">
            <a href="Day05.html" data-alt-hash="day05"><span class="number">5.</span>Day05</a>
            <ul>
              <li class="numbered visible">
                <a href="Day05.html#id-5053eee6be99caad723b2f22524c1e2addfee6e9"><span class="number">5.1.</span>任务详细说明：</a>
                <ul>
                  <li class="numbered visible"><a href="Day05.html#id-2a4b9f847b652c5d8aed18c9d80398b917dab9c7"><span class="number">5.1.1.</span>功能设计</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="numbered visible">
            <a href="Day06.html" data-alt-hash="day06"><span class="number">6.</span>Day06</a>
            <ul>
              <li class="numbered visible">
                <a href="Day06.html#id-8de5978d4021ae9620176dbd1451f544ff8f798e"><span class="number">6.1.</span>任务单详细说明：</a>
                <ul>
                  <li class="numbered visible"><a href="Day06.html#id-4c4580cc53ffa82ec1a481ce14f72537efb100ee"><span class="number">6.1.1.</span>功能设计</a></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </div>
      <div class="content">
        <div class="content-handle"></div>
        <div class="content-container">
          <div class="content-nav content-nav-top">
            <a class="prev-page" href="Day05.html">
            <i class="fa fa-angle-left"></i>
            <span class="number">5.</span>
            Day05
            </a>
          </div>
          <div class="page-toc">
            <ul>
              <li class="numbered visible">
                <a href="#day06"><span class="number">6.</span>Day06</a>
                <ul>
                  <li class="numbered visible">
                    <a href="#id-8de5978d4021ae9620176dbd1451f544ff8f798e"><span class="number">6.1.</span>任务单详细说明：</a>
                    <ul>
                      <li class="numbered visible"><a href="#id-4c4580cc53ffa82ec1a481ce14f72537efb100ee"><span class="number">6.1.1.</span>功能设计</a></li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
          <div class="main-content">
            <h1 id="day06"><span class="number">6.</span>Day06</h1>
            <h2 id="id-8de5978d4021ae9620176dbd1451f544ff8f798e"><span class="number">6.1.</span>任务单详细说明：</h2>
            <h3 id="id-4c4580cc53ffa82ec1a481ce14f72537efb100ee"><span class="number">6.1.1.</span>功能设计</h3>
            <p>此任务单任务主要完成 订单的提交和查询。</br></p>
            <p>订单模块视图：</br> <img src="../img/216.png" alt="订单"/></br></p>
            <p>confirm_order.jsp 订单确认提交页面</br> orderlist.jsp 订单列表页面</br></p>
            <p>订单模块控制器实现： <img src="../img/217.png" alt="订单"/></br></p>
            <p>OrderAction.java 订单的控制器</p>
            <p><span style="color:red">再次强调，以上的图示只是一个参考，你完全可以自行定义任意的Action</span></br></p>
            <p>业务层接口定义：【<span style="color:red">仅供参考</span>】</br></p>
            <pre><code class="java">public interface IOrderService {
    /**
	 * 保存订单对象
	 * 
	 * @param o
	 */
	public void save(Order o);

	/********
	 * 删除订单
	 * 
	 * @param o
	 */
	public void delete(Order o);

	/****
	 * 按主键查询
	 * 
	 * @param id
	 * @return
	 */
	public Order findById(Long id);

	/**
	 * 根据用户查询订单
	 * 
	 * @param user
	 * @param now
	 * @param size
	 * @return
	 */
	public PageBean&lt;Order&gt; queryByPage(User user, int now, int size);

}
</code></pre>
            <p><span style="color:red">只做为代码参考，如果看不懂，请及时咨询项目经理或身边的同学。</span></br></p>
            <p><span style="color:green">业务层实现：请自行实现。</span></br></p>
            <p>数据访问层接口：【IOrderDao.java】</br></p>
            <pre><code class="java">public interface IOrderDao {
    /**
	 * 保存订单
	 * @param o
	 */
	public void save(Order o);
	/*****
	 * 按主键查询
	 * @param id
	 */
	public Order findById(Long id);
	/****
	 * 删除
	 * @param o
	 */
	public void delete(Order o);
	/**
	 * 分页查询订单
	 * @param user
	 * @param now
	 * @param size
	 * @return
	 */
	public List&lt;Order&gt; selectByPage(User user,int now, int size);
	/******
	 * 获取指定用户的总订单数
	 * @return
	 */
	public int rowCount(User user);
}
</code></pre>
            <p><span style="color:green">数据访问层实现：请自行实现。</span></br></p>
            <hr/>
            <p>控制层代码参考：【<span style="color:red">仅供参考</span>】</br></p>
            <pre><code class="java">@WebServlet(urlPatterns = &quot;/permission/order/*&quot;)
public class OrderAction extends HttpServlet {

    /**
	 * 
	 */
	private static final long serialVersionUID = 8771778492874292298L;

	/** 业务接口 */
	private IOrderService orderService;
	private IUserService userService;
	private IBookService bookService;
	private IShoppingCart memoryCart;

	/** 请求URL资源常量 */
	private static final String _TO_BALANCE = &quot;/balance&quot;;// 提交订单
	/*private static final String _SAVE_ADDRESSAJAX = &quot;/saveAddress&quot;;// 保存地址
*/	private static final String _SAVE_ORDER = &quot;/saveOrder&quot;;// 保存订单
	private static final String _TO_ORDERLIST = &quot;/myorders&quot;;// 跳转至订单页面

	public OrderAction() {
		super();
		this.orderService = (IOrderService) BeanFactory.getBean(&quot;orderService&quot;);
		this.userService = (IUserService) BeanFactory.getBean(&quot;userService&quot;);
		this.bookService = (IBookService) BeanFactory.getBean(&quot;bookService&quot;);
	}

	@Override
	protected void service(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
        ....
        ....
</code></pre>
            <p><span style="color:red">控制层的具体实现，请自行实现，上面的代码片段是采用一个Action来处理多个不同的请求的情况，你可以根据你自己的情况来开发，不必拘泥与上面的代码</span></br></p>
            <hr/>
            <p>JSP页面的代码开发：再次查看购物车页面。</br> <img src="../img/214.png" alt="购物车"/></br></p>
            <p>点击结算按钮：</br> 提交结算核心代码：【<span style="color:red">仅供参考，注意url的变化</span>】</br></p>
            <pre><code class="java">function balanceItem(){
    		var count = 0;
			var ids = &quot;&quot;;
			var checks = document.getElementsByName(&quot;itemCheck&quot;);
			
			for(var i=0;i&lt;checks.length;i++){
				if(checks[i].checked){
					count++;
					ids += checks[i].value+&quot;:&quot;;
				}
			}
			
			if(count &gt; 0){
				window.location = &quot;${path }/permission/order/balance?ids=&quot;+ids.substring(0,ids.length-1);
			}else {
				alert(&quot;请至少选中一个商品!&quot;);
			}
			
		}
</code></pre>
            <p><span style="color:red">注：这段代码是在购物车页面中</span></br></p>
            <p>后台控制器逻辑：</p>
            <pre><code class="java">case _TO_BALANCE:
    			String flag = request.getParameter(&quot;flag&quot;);
				PageBean&lt;Book&gt; page = bookService.queryByCondition(1, 3, &quot;猜你喜欢&quot;);
				/** 接收发送过来的参数 */
				String ids = request.getParameter(&quot;ids&quot;);

				String[] arr = ids.split(&quot;:&quot;);// 把接收到的ID分开成数组
				/**
				 * 构建一个商品详情的集合，遍历Id数组，通过id查找每个商品详情
				 * 并且将得到的商品详情放入商品详情的集合，并且转发到确认订单的页面
				 */
				List&lt;OrderItem&gt; items = new ArrayList&lt;&gt;();
				for (String id : arr) {
					OrderItem item = shoppingCart.find(Long.valueOf(id));
					items.add(item);
				}
				if(flag == null){
					List&lt;Address&gt; addrs = new ArrayList&lt;&gt;();
					for(int i =0;i&lt;3;i++){
						addrs.add(addresses.get(i));
					}
					request.setAttribute(&quot;address&quot;, addrs);
				}
				request.setAttribute(&quot;ids&quot;, ids);
				request.setAttribute(&quot;items&quot;, items);
				request.setAttribute(&quot;address&quot;, addresses);
				request.setAttribute(&quot;youlike&quot;, page);
				forward(request, response, true, &quot;/WEB-INF/jsp/user/confirm_order.jsp&quot;);
				break;
</code></pre>
            <p>通过这段控制器代码，可以把订单确认页面呈现给用户，如下：</br> <span style="color:red">订单确认提交页面</span></br>: <img src="../img/218.png" alt="确认订单"/></br></p>
            <p><span style="color:red">注：如果没有地址，请点击使用新地址，添加一个新地址</span></br></p>
            <p>点击“使用新地址”弹出一个添加新地址的页面，如下：【<span style="color:red">仅供参考</span>】</br> <img src="../img/219.png" alt="地址"/></br> 其中，省、市、区要通过AJAX实现动态级联</br> 邮编要进行有效性验证</br> 电话要进行有效性验证</br></p>
            <p>如果勾选 设置默认地址 的话，则将此新增地址为默认地址，之前的默认地址标记清楚。</br></p>
            <p><span style="color:red">控制层代码片段如下：【仅供参考】</span></br></p>
            <pre><code class="java">case _SAVE_ADDRESSAJAX:
    			PrintWriter out = response.getWriter();
				/** 获取页面发送过来的参数信息 */
				/* String baseAddress = request.getParameter(&quot;baseAddress&quot;); */
				String province = request.getParameter(&quot;province&quot;);
				String city = request.getParameter(&quot;city&quot;);
				String area = request.getParameter(&quot;area&quot;);
				String baseAddress = province + &quot;,&quot; + city + &quot;,&quot; + area;
				String detailAddress = request.getParameter(&quot;address_detail&quot;);
				String reciver = request.getParameter(&quot;reciverName&quot;);
				String code = request.getParameter(&quot;code&quot;);
				String tel = request.getParameter(&quot;tel&quot;);
				String isDefault = request.getParameter(&quot;defaultAddress&quot;);
				isDefault = isDefault==null?&quot;0&quot;:isDefault;
				List&lt;Address&gt; addrs = userService.getAddressByUser(user);
				for(int i =0;i&lt;=addrs.size()-1;i++){
					addrs.get(i).setIsDefault(0);
					userService.updAddress(addrs.get(i));
				}

				try {
					// 创建一个地址对象,并且封装对象
					Address address = new Address();
					address.setCode(code);
					address.setReceiver(reciver);
					address.setDetail(detailAddress);
					address.setPhone(tel);
					address.setAddr(baseAddress);
					address.setIsDefault(Integer.parseInt(isDefault));
					address.setUser(user);
					userService.addAddress(address);

					// 成功返回&#39;1&#39;
					out.print(&quot;1&quot;);
				} catch (Exception e) {
					// TODO: handle exception
					// 失败返回&#39;0&#39;
					out.print(&quot;0&quot;);
					e.printStackTrace();
				}
				break;
</code></pre>
            <p>注：</br> <span style="color:red">实现此弹出窗口中的后台的 业务层、持久层请与上面的业务保持一致，此处不再讲诉</span></br></p>
            <hr/>
            <p>在地址选择好后，</br> 点击 提交订单按钮：</br> 后台的控制器的代码片段如下：【<span style="color:red">仅供参考</span>】</br></p>
            <pre><code class="java">case _SAVE_ORDER:
    		/*	String addressId = request.getParameter(&quot;addressId&quot;);*/
				/**获取页面传来的参数*/
				String bids = request.getParameter(&quot;bids&quot;);
				String[] bid = bids.split(&quot;:&quot;);
				/**封装数据对象*/
				Set&lt;OrderItem&gt; orderItems = new HashSet&lt;&gt;();
				Order order = new Order();
				for(Address add : addresses){
				/*order = new Order();*/
				for(String bookId : bid){
				/*	orderItems = new HashSet&lt;&gt;();*/
					OrderItem orderItem = shoppingCart.find(Long.valueOf(bookId));
					orderItem.setOrder(order);
					orderItems.add(orderItem);
					
				}
				order.setItems(orderItems);
				order.setUser(user);
				order.setCreateDate(new Date());
				order.setOrderNo(&quot;TZ&quot;+new Date().getTime());
				order.setOrderStatus(OrderStatus.NO_PAY);
				order.setPhone(user.getTel());
				order.setAddr(add.getAddr());
				order.setReceiver(add.getReceiver());
				}
				/**保存订单*/
				orderService.save(order);
				shoppingCart.clear();
				forward(request, response, false, &quot;/permission/order/myorders&quot;);
				break;
</code></pre>
            <p><span style="color:red">业务层和数据访问层参考上面的接口，此处不再讲诉。</span></br></p>
            <hr/>
            <p>订单列表操作：</br> 通过页面导航点击 我的订单 按钮时，可以查看所有订单：</br> 点击 我的订单 发送请求到控制器:</br> 控制器的代码片段如下：【<span style="color:red">仅供参考</span>】</br></p>
            <pre><code class="java">case _TO_ORDERLIST:
    			/**接受页面参数*/
				String now = request.getParameter(&quot;pageNow&quot;);
				String size = request.getParameter(&quot;pageSize&quot;);
				/**默认当前页为第一页，默认每页显示八条数据*/
				now = now == null?&quot;1&quot;:now;
				size = size == null?&quot;8&quot;:size;
				/**根据参数获取分页对象*/
				PageBean&lt;Order&gt;  paging =(PageBean&lt;Order&gt;) orderService.queryByPage(user, Integer.parseInt(now),Integer.parseInt(size));
				/**转发到订单列表界面*/
				request.setAttribute(&quot;paging&quot;, paging);
				forward(request, response, true, &quot;/WEB-INF/jsp/order/orderlist.jsp&quot;);
                break;
</code></pre>
            <p>转发到orderlist.jsp显示。 <span style="color:red">业务层和数据访问层参考前面 接口，此处不再讲诉。</span></br></p>
            <hr/>
            <p>订单明细：</br> 注：</br> 如果原型界面或你自己想把订单和订单明细分开设计，则此处你需要再次编写查看订单明细的控制器代码 和 相关的JSP页面</br></p>
            <p>具体的代码片断此处不再讲述，可以按自己的理解进行开发。</p>
          </div>
          <div class="content-nav content-nav-bottom">
            <a class="prev-page" href="Day05.html">
            <i class="fa fa-angle-left"></i>
            <span class="number">5.</span>
            Day05
            </a>
          </div>
          <div class="footer">
            <p class="credit text-muted">Powered by <a href="https://github.com/kobo/gaiden">Gaiden</a></p>
          </div>
        </div>
      </div>
    </div>
    <script src="js\jquery-2.1.1.min.js"></script>
    <script src="js\highlight.js"></script>
    <script src="js\application.js"></script>
    <script src="js\my.js"></script>
  </body>
</html>
